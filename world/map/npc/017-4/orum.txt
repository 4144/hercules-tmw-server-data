// Author: Jenalya
// Quest states:
// 14: Completed first part of the quest
// 15: Persuaded the Guarding Spirit to let you into the cave
// 16: Got task to bring materials for first magical flower
// 17: Got task to place the first magical flower
// 18: Placed first magical flower
// 19: Got task to bring materials for second magical flower
// 20: Got task to place the second magical flower
// 21: Placed second magical flower
// 22: Got task to bring materials for third magical flower
// 23: Completed easy minigame and got task to place the third magical flower
// 24: Placed third magical flower
// 25: Got task to bring materials for fourth magical flower
// 26: Completed difficult minigame and got task to place the fourth magical flower
// 27: Placed fourth magical flower
// 28: Got task to bring materials for fifth magical flower
// 29: Failed unbeatable minigame and got the flower hat
// 30: Got task to place the fifth flower
// 31: Placed fifth flower
// 32: Got reward

017-4.gat,211,32,0|script|Orum|158,{

    // first flower
    set @AMOUNT_SMALLMUSHROOM, 5;
    set @AMOUNT_ASH, 5;
    set @RECOMPENSATION_1, 5000;
    // second flower
    set @AMOUNT_PINKPETAL, 5;
    set @AMOUNT_STINGER, 5;
    set @RECOMPENSATION_2, 10000;
    // third flower
    set @AMOUNT_WHITEFUR, 5;
    set @AMOUNT_REDSTINGER, 5;
    set @RECOMPENSATION_3, 20000;

    if (OrumQuest == 24) goto L_PlacedThirdFlower;
    if (OrumQuest == 23) goto L_PlaceThirdFlower;
    if (OrumQuest == 22) goto L_ThirdFlower;

    if (OrumQuest == 21) goto L_PlacedSecondFlower;
    if (OrumQuest == 20) goto L_PlaceSecondFlower;
    if (OrumQuest == 19) goto L_SecondFlower;

    if (OrumQuest == 18) goto L_PlacedFirstFlower;
    if (OrumQuest == 17) goto L_PlaceFirstFlower;
    if (OrumQuest == 16) goto L_FirstFlower;

    if (OrumQuest == 15) goto L_InitialTalk;

    goto L_Banish;

L_InitialTalk: // 15: Persuaded the Guarding Spirit to let you into the cave
    mes "[Orum]";
    mes "\"I... My Guarding Spirit... You... What...\"";
    mes "[Waric]";
    mes "\"Pull yourself together!\"";
    next;
    mes "[Orum]";
    mes "\"Y-yes, master.\"";
    mes "He turns to you.";
    mes "\"I told you not to follow us! Are you so eager to die?\"";
    menu
        "I'm here to offer my service...", -,
        "Hah, you thought you could hide from me?", L_Banish,
        "Keep calm, I want to work together with you.", -,
        "D-d-die?!", L_Banish;

    mes "[Orum]";
    mes "\"You want to help us?\"";
    mes "Waric raises his eyebrows...";
    next;
    mes "[Orum]";
    mes "\"I don't think that's a good idea.\"";
    menu
        "You won't know until you try.", -,
        "You have no choice, I found your hideout!", L_Banish;

    mes "[Orum]";
    mes "\"Well, why not. Here is a simple task to proof you're serious.";
    mes "Bring me " + @AMOUNT_SMALLMUSHROOM + " Small Mushrooms, " + @AMOUNT_ASH + " Piles of Ash and one Orange Tulip.\"";

    set OrumQuest, 16;
    menu
        "Sure!", L_Close,
        "Why do you need that?", -;

    mes "[Orum]";
    mes "\"Don't ask stupid questions! Do what I told you.\"";
    mes "...";
    mes "\"Those things are ingredients for a magical artifact. You don't need to know more at the moment.\"";
    goto L_Close;

L_Banish:
    mes "[Orum]";
    mes "\"This will be the last mistake you did...\"";
    mes "He starts mumbering and you suddenly feel weirdly weightless. Your vision fades...";
    mes "You last thing you hear is Waric shouting something about untalented apprentices.";
    set Hp, 1 + rand(5);
    warp "017-1.gat", 0, 0;
    goto L_Close;

L_FirstFlower: // 16: Got task to bring materials for first magical flower
    mes "[Orum]";
    mes "\"So? Where are the " + @AMOUNT_SMALLMUSHROOM + " Small Mushrooms, " + @AMOUNT_ASH + " Piles of Ash and Orange Tulip you should bring?\"";
    menu
        "I have everything you want!", -,
        "I don't have it yet.", L_Close;

    if ((countitem("SmallMushroom") < @AMOUNT_SMALLMUSHROOM)
        || (countitem("PileOfAsh") < @AMOUNT_ASH)
        || (countitem("OrangeTulip") < 1))
        goto L_NoItem;

    delitem "SmallMushroom", @AMOUNT_SMALLMUSHROOM;
    delitem "PileOfAsh", @AMOUNT_SMALLMUSHROOM;
    delitem "OrangeTulip", 1;
    getitem "BlueRose", 1; // TODO: replace with magical flower artefact
    set OrumQuest, 17;

    mes "Orum takes the items and starts to pulverize them, mixes some of it together in the caldron and finally dips the tulip into it, mumbering enchantements. The tulip changes its appearance. Then he hands it over to you.";
    mes "[Orum]";
    mes "\"Phew, done. Now I feel exhausted. You need to place it at its destination.\"";
    next;
L_WayFirstFlower:
    mes "\"We prepared a place for this in the forest outside the caves. When you left the cave, go some steps to the east and you'll find a spot of grass with flowers on a small hill. There you have to place it, right in the middle.\"";
    goto L_Close;

L_PlaceFirstFlower: // 17: Got task to place the first magical flower
    mes "[Orum]";
    mes "\"Go ahead and place the first magical flower.\"";
    menu
        "Ok, will do that.", L_Close,
        "Can you explain the way again?", L_WayFirstFlower,
        "I... I lost it.", -;

    mes "[Orum]";
    mes "\"What?! I can't believe it! How can you handle a powerful magical artifact in such a careless way?\"";
    next;
    mes "\"This behaviour shouldn't remain unpunished. Pay a recompensation fee of " + @RECOMPENSATION_1 + " GP, and I'm going to allow you to continue helping us. So?\"";
    menu
        "Ok.", -,
        "No way, that's too much!", L_NoRecompensation;

    if (Zeny < @RECOMPENSATION_1)
        goto L_NoMoney;
    set Zeny, Zeny - @RECOMPENSATION_1;
    set OrumQuest, 16;

    mes "[Orum]";
    mes "\"Very well. Now bring me " + @AMOUNT_SMALLMUSHROOM + " Small Mushrooms, " + @AMOUNT_ASH + " Piles of Ash and one Orange Tulip again, so we can start over.\"";
    goto L_Close;

L_PlacedFirstFlower: // 18: Placed first magical flower
    mes "[Orum]";
    mes "\"I felt the eruption of magical power when you placed it! Wonderful! Let's start with the next one right now.\"";
    menu
        "Ok, what should I do now?", -,
        "Weird monsters appeared when I placed it!", L_AskMonsters;

    set OrumQuest, 19;
    goto L_SecondFlower;

L_AskMonsters:
    mes "[Orum]";
    mes "\"Oh, right. Well, that was to be expected, some of the power seeped out when you placed it. I hope those monsters didn't harm you?";
    mes "However, we should continue.\"";
    set OrumQuest, 19;
    next;
    goto L_SecondFlower;

L_SecondFlower: // 19: Got task to bring materials for second magical flower
    mes "[Orum]";
    mes "\"Bring me " + @AMOUNT_PINKPETAL + " Pink Petals, " + @AMOUNT_STINGER + " Scorpion Stinger and one Purple Tulip.\"";
    menu
        "I have it.", -,
        "All right, I'll get it.", L_Close,
        "What's the purpose of this?", L_AskPurpose;

    if ((countitem("PinkPetal") < @AMOUNT_PINKPETAL)
        || (countitem("ScorpionStinger") < @AMOUNT_STINGER)
        || (countitem("PurpleTulip") < 1))
        goto L_NoItem;

    delitem "PinkPetal", @AMOUNT_PINKPETAL;
    delitem "ScorpionStinger", @AMOUNT_STINGER;
    delitem "PurpleTulip", 1;
    getitem "BlueRose", 1; // TODO: replace with magical flower artefact
    set OrumQuest, 20;

    mes "Orum starts to handle the material similiar to the ones for the first flower. Suddenly something from the pulver gets on his hand and it makes a nasty frizzling sound. He yells in pain. After cleaning his hand he continues. At the end he gives you another magical flower while rubbing his hand.";
    next;
    mes "[Orum]";
    mes "\"Ouch, it still hurts. I need to recover. You're going to place it.\"";
    next;
L_WaySecondFlower:
    mes "[Orum]";
    mes "\"The next spot is in the Woodland Hills. When you left our caves, go south until you come out of the forest and then to the west, past the hut of that old man.";
    mes "The spot where you have to place it is on higher ground, so you eventually have to find a way through the caves to reach it.\"";
    goto L_Close;

L_AskPurpose:
    mes "[Orum]";
    mes "\"Purpose? Well... We're buidling a pentagram.\"";
    goto L_Close;

L_PlaceSecondFlower: // 20: Got task to place the second magical flower
    mes "[Orum]";
    mes "\"Go to place second magical flower.\"";
    menu
        "I'm on my way.", L_Close,
        "Where do I have to put it again?", L_WaySecondFlower,
        "Sorry, I lost it.", -;

    mes "[Orum]";
    mes "\"What?! You incompetent dumbhead! I got hurt while creating this powerful magical artifact and you lose it!\"";
    next;
    mes "\"This behaviour shouldn't remain unpunished. Pay a recompensation fee of " + @RECOMPENSATION_2 + " GP, and I'm going to allow you to continue helping us. So?\"";
    menu
        "Ok.", -,
        "No way, that's too much!", L_NoRecompensation;

    if (Zeny < @RECOMPENSATION_2)
        goto L_NoMoney;
    set Zeny, Zeny - @RECOMPENSATION_2;
    set OrumQuest, 19;

    mes "[Orum]";
    mes "\"Ok, now that this is settled, bring me " + @AMOUNT_PINKPETAL + " Pink Petals, " + @AMOUNT_STINGER + " Scorpion Stinger and one Purple Tulip again.\"";
    goto L_Close;

L_PlacedSecondFlower: // 21: Placed second magical flower
    mes "[Orum]";
    mes "\"Very good. You placed the second flower, right? I was able to feel it here.";
    mes "Everything is going very well.\"";
    mes "Orum grins pleased.";
    menu
        "What do you need next?", -,
        "How can we build a pentagram by randomly planting flowers?", L_AskPentagram;

    set OrumQuest, 22;
    goto L_ThirdFlower;

L_AskPentagram:
    mes "[Orum]";
    mes "\"Randomly? The places are very carefully chosen! You see, it's going to be a very BIG pentagram.\"";
    set OrumQuest, 22;
    next;
    goto L_ThirdFlower;

L_ThirdFlower: // 22: Got task to bring materials for third magical flower
    mes "[Orum]";
    mes "\"Now we need " + @AMOUNT_WHITEFUR + " White Fur, " + @AMOUNT_REDSTINGER + " Red Scorpion Stinger and one White Tulip.\"";
    menu
        "I got everything you want.", -,
        "I'm still searching.", L_Close,
        "And what is the pentagram going to do?", L_AskPentaEffect;

    if ((countitem("WhiteFur") < @AMOUNT_WHITEFUR)
        || (countitem("RedScorpionStinger") < @AMOUNT_REDSTINGER)
        || (countitem("WhiteTulip") < 1))
        goto L_NoItem;

    delitem "WhiteFur", @AMOUNT_WHITEFUR;
    delitem "RedScorpionStinger", @AMOUNT_REDSTINGER;
    delitem "WhiteTulip", 1;

    mes "Orum takes the things out of your hands and starts to prepare them.";
    mes "[Orum]";
    mes "\"This time you're going to help me. It's safer when I don't have to handle all of it myself. Ok, listen.\"";
    next;
    mes "\"Here is the rheological additive that you have to pour on it when the reaction between the pulvers is on its peak level. I'm going to slowly add a little more of the pulver, which will make it react faster. Got it?\"";
    menu
        "Rheo-what?", -,
        "Ok, let's try.", -,
        "I'm not sure I understand...", -;

    mes "[Orum]";
    mes "\"Well, just pour when it's bubbling really hard.\"";
    mes "He starts to mix the powders together in the caldron.";
    next;

    setarray @bubblingLevels$, "calmly", "slightly", "noticeably", "heavily";
    set @bubblingLevel, rand(10);

L_EasyMinigame:
    mes "The mixture is bubbling " + @bubblingLevels$[@bubblingLevel/7] + ". What do you want to do?";
    menu
        "Wait.", -,
        "Pour.", L_EasyCheck;

    if (@menu == 1)
        set @bubblingLevel, @bubblingLevel + rand(1,10);
    if (@bubblingLevel > 27)
        goto L_EasyTooHigh;
    mes "Orum adds some more pulver.";
    goto L_EasyMinigame;

L_EasyCheck:
    set @bubblingLevel, @bubblingLevel + 3 - rand(7);
    if (@bubblingLevel < 22)
        goto L_EasyTooEarly;
    if (@bubblingLevel > 27)
        goto L_EasyTooHigh;
    goto L_EasySuccess;

L_EasyTooHigh:
    mes "Suddenly the mixture glows brightly. Then it calms down very quickly and turns into a weird greyish color.";
    mes "[Orum]";
    mes "\"Are you sleeping? Now it's wasted. You waited too long.\"";
    next;
    mes "\"Now you have to collect the ingredients again.\"";
    goto L_Close;

L_EasyTooEarly:
    mes "You pour the liquid Orum gave you on this mixture.";
    mes "It stops bubbling and gets thicker... and thicker... and thicker...";
    mes "[Orum]";
    mes "\"No! That was too early. See what you've done. It's hard as a rock now.\"";
    next;
    mes "\"How annoying. You have to get new ingredients.\"";
    goto L_Close;

L_EasySuccess:
    getitem "BlueRose", 1; // TODO: replace with magical flower artefact
    set OrumQuest, 23;

    mes "As you pour the liquid on the bubbling mixture, it calms down and becomes viscous. Orum takes the tulip and dips it into the mixture.";
    mes "[Orum]";
    mes "\"Very well! Here it is.\"";
    next;
L_WayThirdFlower:
    mes "[Orum]";
    mes "\"This flower needs to be placed on top of the Hurnscald mines. It might be a bit hard to reach, but I'm sure you'll do fine.\"";
    goto L_Close;

L_AskPentaEffect:
    mes "[Orum]";
    mes "\"Don't you have at least tiny knowledge of Astral magic? A pentagram is used to summon, of course.\"";
    goto L_Close;

L_PlaceThirdFlower: // 23: Completed easy minigame and got task to place the third magical flower
    mes "[Orum]";
    mes "\"What are you waiting for? Bring the third flower to its destination.\"";
    menu
        "Ok.", L_Close,
        "I forget where to put it.", L_WayThirdFlower,
        "Unfortunately... I don't have it anymore.", -;

    mes "Orum sighs.";
    mes "[Orum]";
    mes "\"I hope this is a joke. No, you're serious? What an effrontery! This was a valuable and powerful magical artifact.\"";
    next;
    mes "\"This behaviour shouldn't remain unpunished. Pay a recompensation fee of " + @RECOMPENSATION_3 + " GP, and I'm going to allow you to continue helping us. So?\"";
    menu
        "Here it is.", -,
        "That's too much!", L_NoRecompensation;

    if (Zeny < @RECOMPENSATION_3)
        goto L_NoMoney;
    set Zeny, Zeny - @RECOMPENSATION_3;
    set OrumQuest, 22;

    mes "[Orum]";
    mes "\"Once again we need " + @AMOUNT_WHITEFUR + " White Fur, " + @AMOUNT_REDSTINGER + " Red Scorpion Stinger and one White Tulip.\"";
    goto L_Close;

L_PlacedThirdFlower: // 24: Placed third magical flower
    mes "[Orum]";
    mes "TODO next";
    goto L_Close;

L_NoRecompensation:
    mes "[Orum]";
    mes "\"Well, you could still try to get back the magical flower instead. Your decision.\"";
    goto L_Close;

L_NoMoney:
    mes "[Orum]";
    mes "\"Hey, you don't have enough money!\"";
    goto L_Close;

L_NoItem:
    mes "[Orum]";
    mes "\"Hey, you don't have it!\"";
    goto L_Close;

L_Close:
    set @AMOUNT_SMALLMUSHROOM, 0;
    set @AMOUNT_ASH, 0;
    set @RECOMPENSATION_1, 0;
    set @AMOUNT_PINKPETAL, 0;
    set @AMOUNT_STINGER, 0;
    set @RECOMPENSATION_2, 0;
    set @AMOUNT_WHITEFUR , 0;
    set @AMOUNT_REDSTINGER , 0;
    set @RECOMPENSATION_3, 0;
    set @bubblingLevel, 0;
    cleararray @bubblingLevels$[0], "", 4;
    close;
}
